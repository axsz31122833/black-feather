## 範圍與交付
- 不含電子支付，其餘功能完成到可營運：叫車→派單→定位→開始→結束（固定扣 20 元）→取消、預約排程、管理監控、權限安全、錯誤處理
- 交付：完整 E2E 流程、管理端監控與操作、RLS 安全策略、排程與日誌監控、故障再指派與心跳檢測

## 後端（Supabase）
- 資料庫與 RPC：將 `003 → 004 → 006` 合併為最終遷移並套用；驗證四個 RPC 可執行；插入一筆 `pricing_rules(active=true)`
- Edge Functions：確認並部署 `request_ride / assign_driver / update_location / start_ride / finish_ride / cancel_ride / schedule_checker`，Secrets 設置 `SERVICE_ROLE_KEY`、`SUPABASE_URL`
- 排程：Dashboard 建立 `schedule_checker` 每分鐘（* * * * *），加執行結果記錄（成功/失敗）與重試護欄（如遇鎖定或無司機）
- 自動派單策略：距離 + `updated_at` 最新 + `is_online=true`；若 30 秒未接或指派失敗→再指派其他司機；為 `rides` 增加 `assignment_attempts`、`last_assignment_at`
- 司機心跳：建議 3–5 秒上報；離線判定 60–90 秒；`drivers.is_online/status` 自動切換；心跳超時釋放當前行程的指派

## 安全與權限（RLS）
- `passengers`：僅本人可讀寫基本欄位（電話、姓名）；管理員可讀全表
- `drivers`：本人可讀寫 `is_online/current_lat/current_lng/status`；管理員可讀寫全表
- `rides`：乘客可讀自己行程；司機可讀派給自己的行程；插入/更新以 Edge Functions 完成（前端不直接寫）
- `driver_locations` / `ride_locations`：僅管理員與 Edge Functions 寫入；乘客/司機透過 Realtime 讀取

## Realtime 與監控
- 啟用 Postgres Changes；訂閱 `driver_locations` 與 `rides`（依角色過濾）
- Edge Functions Logs 監看與錯誤告警（Dashboard）；關鍵錯誤（派單失敗、心跳超時）記錄到審計表 `ops_events`

## 前端（Uber 風格落地）
- 乘客首頁：地圖選點（上車/下車）、車型選擇（可先固定）、預估距離與時間、叫車與顯示 ETA；成功後顯示司機資訊卡
- 乘客行程頁：開始/結束/取消控制、路徑軌跡、狀態標籤
- 司機首頁：上線/下線切換、接單提示面板（接/拒）、地圖導航至乘客位置、位置上報控制
- 司機行程頁：開始/結束、顯示路線與乘客資訊
- 管理端：即時司機位置地圖、派單與釋放控件、統計卡片（總行程、進行中、今日完成、離線司機數）、預約單列表與手動執行排程

## 例外處理與再指派
- 指派失敗或司機超時未接：標記 `rides.status='waiting_assignment'` 並計數，再指派下一位司機
- 取消策略：乘客取消時判斷是否收取取消費（可先記錄原因與時間窗），司機取消需回到 `waiting_assignment`

## E2E 驗證流程
- 乘客：登入→設定起迄點→叫車→派單→顯示司機 ETA→開始→路徑記錄→結束（確認 `final_price_cents` 扣 20 元）→取消情境測試
- 司機：登入→上線→接單（接/拒）→導航接客→開始→結束→位置持續上報→離線超時與再指派測試
- 預約：建立 `scheduled_rides`（近時窗）→排程自動指派→`processed=true`；手動觸發排程驗證
- Realtime：`driver_locations` 與 `rides` 事件在乘客/司機/管理端即時更新；斷線重連與重試
- 管理端：地圖監看、派單重試、司機上下線、計價規則建立、統計卡片數值核對

## 風險與回滾
- SQL 套用衝突：使用 `IF NOT EXISTS` 與單獨 Schema 測試；必要時先備份
- 函式部署失敗：逐一部署定位錯誤；檢查 Secrets 與環境變數
- Realtime 未觸發：檢查專案 Realtime 設定與表權限；Channel 訂閱過濾條件

---
若你確認此計劃，我將開始：套用 RLS 與最終遷移、完成派單護欄與心跳邏輯、優化前端四頁並啟動排程，最後跑完整 E2E 測試並回報問題清單與修復方案。