## 前提準備
- 取得並確認專案參數：`SUPABASE_URL`、`SUPABASE_REF`、`SUPABASE_SERVICE_ROLE_KEY`、`VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`、`VITE_SUPABASE_FUNCTIONS_URL`
- 目標 Supabase 專案已啟用 Postgres（含 Realtime）與 Edge Functions

## 資料庫遷移與 RPC 套用
- 在 Supabase SQL Editor 依序執行：
  - `scripts/supabase/sql/003_uuid_core_tables.sql`（建立 `passengers/drivers/rides` 與電話唯一索引、`driver_locations/ride_locations/scheduled_rides/pricing_rules/penalties`）
  - `scripts/supabase/sql/004_uuid_rpc.sql`（`find_nearest_online_driver`、`upsert_driver_location`、`insert_ride_location`、`compute_ride_distance_km`）
  - `scripts/supabase/sql/006_uuid_rpc_fix.sql`（補強 `drivers` 欄位與 `driver_locations` upsert 索引）
- 檢查：
  - `passengers_phone_unique`、`drivers_phone_unique` 皆存在
  - RPC 可執行（以 SQL Console `select * from find_nearest_online_driver(...)` 簡測）

## Edge Functions 部署
- 設定部署環境變數：`SUPABASE_REF`、`SUPABASE_URL`、`SUPABASE_SERVICE_ROLE_KEY`
- 在 `scripts` 目錄執行部署腳本：`supabase-deploy.ps1`
- 確認已部署的函式：`request_ride`、`assign_driver`、`update_location`、`start_ride`、`finish_ride`、`cancel_ride`、`schedule_checker`（可選：`auto-dispatch`）

## 排程設定
- Supabase Dashboard → Edge Functions → Schedules
- 為 `schedule_checker` 建立排程：`* * * * *`（每 1 分鐘）
- 驗證：建立一筆 `scheduled_rides`，於窗口時間自動建立 `rides` 並標記 `processed=true`

## 前端環境與路由驗證
- `.env` 設定 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`、`VITE_SUPABASE_FUNCTIONS_URL`
- 啟動前端並驗證路由：`/login`、`/passenger`、`/passenger/ride`、`/driver`、`/driver/ride`、`/admin`
- 管理頁 `AdminDashboard.jsx`：
  - 即時監看 `driver_locations`、`rides`
  - 以表單建立 `passengers`、`drivers`，並切換司機上線/下線
  - 地圖（Canvas）顯示司機位置

## E2E 流程驗證
- 登入：於 `/login` 以電話登入並驗證 OTP
- 乘客叫車：`/passenger` 輸入乘客 ID 與起迄點 → `request_ride` 回傳 `ride_id`
- 自動/手動派單：按「派單」呼叫 `assign_driver`，確認最近在線司機被指派
- 司機定位：`/driver` 上線並上報座標，管理頁即時更新；如有進行中行程，`ride_locations` 會累積路徑
- 開始/結束：`/passenger/ride` 或 `/driver/ride` 操作 `start_ride`、`finish_ride`；完成後檢查 `final_price_cents` 已扣 20 元
- 取消：測試 `cancel_ride`（釋放司機，選擇性紀錄 `penalties`）
- 預約：`ScheduledRidesPage` 建立預約 → 等待排程自動指派並標記 `processed`

## 風險與回滾
- 若 SQL 衝突：以 `IF NOT EXISTS` 設計減少影響；必要時備份既有表或採用單獨 schema
- 若 Functions 部署失敗：檢查 `SUPABASE_REF/URL/SERVICE_ROLE_KEY`；逐一部署函式以定位問題
- Realtime 未觸發：檢查 Supabase Realtime 設定、資料表權限、前端 `apikey` header 與頻道訂閱

## 進一步優化（可選）
- 改用 Next.js 路由結構（`pages/` 或 `app/`）並導入保護路由
- 地圖套件：改用 Google Maps 或 Leaflet 替代 Canvas，顯示司機/乘客標記與路徑
- 司機排班與 ETA：在 `assign_driver` 加權距離/更新時間與即時 ETA
- 訂價規則管理：新增 Admin 設定頁，管理 `pricing_rules`（含倍數）

---
若你確認以上計劃，我將開始執行：套用 SQL、部署 Functions、設定排程，並跑完整 E2E 驗證。