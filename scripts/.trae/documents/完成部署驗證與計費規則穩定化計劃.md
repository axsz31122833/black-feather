## 目標
- 完成 Supabase 上的部署與驗收，確保叫車→派單→定位→開始→結束→計費（固定扣 20 元）→取消、以及預約排程可正常運作。
- 將計費規則 `pricing_rules` 與距離計算流程穩定化，避免欄位不一致導致錯誤。

## 資料庫檢查與修補
- 確認已執行 SQL：`003_uuid_core_tables.sql`、`004_uuid_rpc.sql`、`006_uuid_rpc_fix.sql`
- 新增/確認 `pricing_rules` 單筆種子資料：`base_fare_cents`、`per_km_cents`、`per_minute_cents`，並設定 `active=true`
- 檢查 `driver_locations` 的 unique index（`driver_id`）存在，RPC upsert 可用
- 檢查 `passengers_phone_unique`、`drivers_phone_unique` 唯一約束生效

## Edge Functions 行為驗證
- `finish_ride`：使用簡化的定價欄位（不依賴不存在的 `effective_from` 和倍數欄位），應正確計算並扣 20 元
- `assign_driver`：RPC 參數採 `p_pickup_lat/p_pickup_lng`，能選到最近且在線司機
- `update_location`：若司機有進行中行程，能寫入 `ride_locations`（RPC 參數採 `p_ride_id`）
- `schedule_checker`：每分鐘排程能將 `scheduled_rides` 生成 `rides` 並標記 `processed=true`

## 排程與監控
- 在 Supabase Dashboard 設定 `schedule_checker` 為 `* * * * *`
- 建立監控方式：
  - Edge Function logs（Supabase Dashboard）
  - 失敗重試手動端點（必要時）

## 前端驗證
- `.env` 變數設置：`VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`、`VITE_SUPABASE_FUNCTIONS_URL`
- 登入：`/login` 以電話和 OTP 驗證
- 管理：`/admin` 即時監看 `driver_locations/rides`，用表單建立乘客/司機、切換司機上線/下線；Canvas 地圖標示位置
- 乘客：`/passenger` 叫車→取得 `ride_id`→派單；`/passenger/ride` 開始/結束/取消
- 司機：`/driver` 上線/下線與位置上報；`/driver/ride` 開始/結束

## E2E 測試案例
- 正常完成：叫車→派單→定位→開始→結束；檢查 `final_price_cents` 已扣 20 元
- 取消：在不同狀態下取消，司機狀態回復、可選記錄 `penalties`
- 預約：建立 `scheduled_rides`→排程自動指派→`processed=true`

## 安全與權限（後續強化）
- 設定 RLS：`passengers`、`drivers`、`rides` 基本讀取/寫入策略（前端以使用者身分受限）
- Functions 使用 Service Role Key 僅在 Edge Functions；前端僅持有 `anon` key

## 效能與索引（後續強化）
- 為 `rides(status, driver_id, passenger_id)`、`ride_locations(ride_id)` 加索引
- 驗證距離查詢的 PostGIS 索引使用率（`driver_locations` 的 GIST geography）

## 可選優化
- 路由改為 Next.js 結構並加入保護路由與中介層
- 地圖改用 Google Maps / Leaflet，視覺化標記與路徑
- Admin 設定頁：管理 `pricing_rules`（含倍數與生效時間）

---
若你確認此計劃，我將開始在你的 Supabase 專案執行 SQL 套用、部署 Functions、設定排程，並跑完 E2E 驗證，確保系統正式可運作。